@page "/risk"
@using FloodApp.State
@using FloodApp.Services
@using FloodApp.Models
@using FloodApp.Components.UI
@using FloodApp.Components.Maps
@using FloodApp.Components.Location
@inject NavigationManager Nav
@inject AppState AppState
@inject RiskService RiskService
@inject WeatherService WeatherService
@inject ShelterService ShelterService
@inject HistoricalDataService HistoricalData
@inject MLPredictionService MLPrediction
@inject AIFloodPredictor AIPredictor
@inject LocationService LocService
@inject IJSRuntime JS
@layout FloodApp.Components.Layout.MainLayout

<div class="h-screen w-full bg-gray-900 grid" style="grid-template-columns: 420px 1fr;">
    
    <!-- Left Panel: Analysis & Info -->
    <div class="h-full risk-sidebar p-6 flex flex-col gap-5 overflow-y-auto z-10 shadow-xl" id="risk-report">
        
        <div class="flex items-center gap-2 mb-1">
            <AppButton Variant="AppButton.ButtonVariant.Ghost" 
                       Color="AppButton.ButtonColor.Neutral"
                       OnClick="@GoBack">
                <Icon SvgContent='<path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' />
                Back
            </AppButton>
            <span class="text-secondary">Analysis Result</span>
        </div>

        @if (IsCalculating)
        {
            <div class="flex-1 flex flex-col items-center justify-center gap-4">
                <div class="spinner border-4 border-purple-500 border-t-transparent rounded-full w-12 h-12 animate-spin"></div>
                <p>Analyzing Risk...</p>
                <p class="text-xs text-secondary">Calculating risk, checking weather conditions...</p>
            </div>
        }
        else if (AppState.SelectedLatLng == null)
        {
             <div class="flex-1 flex items-center justify-center">
                <AppButton OnClick="@(() => Nav.NavigateTo("/location"))">Select Location</AppButton>
            </div>
        }
        else
        {
            <!-- AI Generation Report (Gemini) -->
            <Panel>
                <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-700">
                    <span class="text-xl">‚ú®</span>
                    <h3 class="text-md font-bold text-white">AI General Risk Assessment</h3>
                </div>
                @if (!string.IsNullOrEmpty(_aiReportMarkdown))
                {
                    <pre class="text-sm text-gray-200 whitespace-pre-wrap font-sans">@_aiReportMarkdown</pre>
                }
                else
                {
                    <p class="text-sm text-yellow-400">Failed to generate AI Risk Report.</p>
                }
            </Panel>
            
            <!-- ML Prediction Report (Random Forest) -->
            @if (_mlPrediction != null)
            {
                <Panel>
                    <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-700">
                        <span class="text-xl">ü§ñ</span>
                        <h3 class="text-md font-bold text-white">Machine Learning Assessment</h3>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-gray-800 p-3 rounded border border-gray-700">
                            <div>
                                <h4 class="text-xs text-gray-400 uppercase tracking-widest font-semibold mb-1">Division Profile (Historical)</h4>
                                <span class="text-sm">Based on @(_mlPrediction.HistoricalEventCount) past events</span>
                            </div>
                            <div class="px-3 py-1 rounded bg-gray-900 font-bold border 
                                @(_mlPrediction.PredictedSeverity == "HIGH" ? "text-red-500 border-red-900" :
                                  _mlPrediction.PredictedSeverity == "MEDIUM" ? "text-yellow-500 border-yellow-900" : 
                                  "text-green-500 border-green-900")">
                                @_mlPrediction.PredictedSeverity
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center bg-gray-800 p-3 rounded border border-gray-700">
                            <div>
                                <h4 class="text-xs text-gray-400 uppercase tracking-widest font-semibold mb-1">Impact Forecast</h4>
                                <span class="text-sm">Predicted affected population</span>
                            </div>
                            <div class="font-bold text-xl text-primary">
                                @(_mlPrediction.PredictedAffected) <span class="text-sm font-normal text-gray-400">people</span>
                            </div>
                        </div>
                    </div>
                </Panel>
            }
            
            <!-- Weather Escalation Badge -->
            @if (AppState.CurrentRisk.WasEscalated && !string.IsNullOrEmpty(AppState.CurrentRisk.EscalationReason))
            {
                <div class="escalation-badge">
                    <span class="escalation-icon">‚ö†Ô∏è</span>
                    <span class="escalation-text">@AppState.CurrentRisk.EscalationReason</span>
                </div>
            }

            <!-- Nearest Safe Zone (for High/Medium) -->
            @if (AppState.CurrentRisk.Level != RiskLevel.Low && NearestSafeZone != null)
            {
                <Panel>
                    <h3 class="text-sm font-bold text-secondary mb-2">üõ°Ô∏è Nearest Safe Zone</h3>
                    <div class="safe-zone-info">
                        <div class="safe-zone-name">
                            <span class="safe-dot"></span>
                            <span>@NearestSafeZone.Value.ZoneName</span>
                        </div>
                        <div class="safe-zone-distance">
                            <span class="distance-value">@NearestSafeZone.Value.DistanceKm.ToString("F1") km</span>
                            <span class="distance-label">away</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Consider evacuating towards this low-risk area if conditions worsen.</p>
                </Panel>
            }
            
            <!-- Recommendations -->
            <Panel>
                <h3 class="text-sm font-bold text-secondary mb-2">Recommendations</h3>
                <ul class="text-sm list-disc pl-4 space-y-2 text-gray-300">
                    @if (AppState.CurrentRisk.Level == RiskLevel.High)
                    {
                        <li>Evacuate to higher ground immediately if water rises.</li>
                        <li>Keep emergency kit ready.</li>
                        <li>Follow official DMC alerts.</li>
                        <li>Avoid crossing flooded roads and bridges.</li>
                    }
                    else if (AppState.CurrentRisk.Level == RiskLevel.Medium)
                    {
                        <li>Monitor rain levels closely.</li>
                        <li>Prepare for potential evacuation.</li>
                        <li>Secure important documents and valuables.</li>
                    }
                    else
                    {
                        <li>Area is generally safe from floods.</li>
                        <li>Stay updated during heavy monsoons.</li>
                    }
                </ul>
            </Panel>

            <!-- Nearby Shelters -->
            @if (NearbyShelters != null && NearbyShelters.Any())
            {
                <Panel>
                    <h3 class="text-sm font-bold text-secondary mb-2">üè• Nearby Emergency Centers</h3>
                    <div class="space-y-3 mt-3">
                        @foreach (var shelter in NearbyShelters)
                        {
                            <div class="p-3 bg-gray-800 rounded border border-gray-700">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-bold text-gray-200 text-sm">@shelter.Name</span>
                                    <span class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">@shelter.DistanceKm.ToString("F1") km</span>
                                </div>
                                <div class="text-xs text-gray-400 mb-2">Type: @shelter.Type.ToString()</div>
                                
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-xs text-secondary flex items-center gap-1">
                                        üìû <a href="tel:@shelter.ContactNumber" class="text-primary hover:underline">@shelter.ContactNumber</a>
                                    </span>
                                    <span class="text-xs @(shelter.IsFull ? "text-red-400" : "text-green-400")">
                                        @(shelter.IsFull ? "FULL" : $"Cap: {shelter.CurrentOccupancy}/{shelter.Capacity}")
                                    </span>
                                </div>
                            </div>
                        }
                    </div>
                </Panel>
            }

            <!-- Weather Widget (Live) -->
            <Panel>
                <WeatherWidget Location="@AppState.SelectedLatLng" />
            </Panel>

            <!-- 7-Day Forecast -->
            <Panel>
                <ForecastWidget Location="@AppState.SelectedLatLng" />
            </Panel>

            <!-- Rainfall Trend Chart -->
            <Panel>
                <RainfallChart Location="@AppState.SelectedLatLng" />
            </Panel>

            <!-- Emergency Contacts -->
            <Panel>
                <h3 class="text-sm font-bold text-secondary mb-2">Emergency Contacts</h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between bg-gray-800 p-2 rounded border border-gray-700">
                        <div class="flex items-center gap-2">
                            <span class="text-red-400">üö®</span>
                            <span class="text-sm text-gray-200">DMC Hotline</span>
                        </div>
                        <a href="tel:117" class="text-sm font-bold text-primary hover:text-primary-light">117</a>
                    </div>
                    <div class="flex items-center justify-between bg-gray-800 p-2 rounded border border-gray-700">
                        <div class="flex items-center gap-2">
                            <span class="text-blue-400">üöì</span>
                            <span class="text-sm text-gray-200">Police Emergency</span>
                        </div>
                        <a href="tel:119" class="text-sm font-bold text-primary hover:text-primary-light">119</a>
                    </div>
                    <div class="flex items-center justify-between bg-gray-800 p-2 rounded border border-gray-700">
                        <div class="flex items-center gap-2">
                            <span class="text-green-400">üöë</span>
                            <span class="text-sm text-gray-200">Ambulance</span>
                        </div>
                        <a href="tel:1990" class="text-sm font-bold text-primary hover:text-primary-light">1990</a>
                    </div>
                </div>
            </Panel>

            <!-- Action Buttons -->
            <div class="action-buttons mt-auto">
                <AppButton Class="w-full" 
                           Variant="AppButton.ButtonVariant.Filled"
                           Color="AppButton.ButtonColor.Danger"
                           OnClick="@ReportDamage">
                    üö® Report Damage / Claim
                </AppButton>
                <AppButton Class="w-full" 
                           Variant="AppButton.ButtonVariant.Outline"
                           Color="AppButton.ButtonColor.Primary"
                           OnClick="@PrintReport">
                    üìÑ Download Report
                </AppButton>
                <AppButton Class="w-full" 
                           Variant="AppButton.ButtonVariant.Outline"
                           Color="AppButton.ButtonColor.Neutral"
                           OnClick="@NewCheck">
                    Check Another Location
                </AppButton>
            </div>
        }
    </div>

    <!-- Right Panel: Map -->
    <div class="h-full relative bg-black overflow-hidden">
        @if (AppState.SelectedLatLng != null)
        {
             <RiskMapView Shelters="@NearbyShelters" />
             
             <!-- Risk Legend Overlay -->
             <div class="absolute bottom-4 right-4 bg-gray-900/90 backdrop-blur p-4 rounded-lg border border-gray-700 z-[1000]">
                 <h4 class="text-xs font-bold text-secondary mb-2 uppercase tracking-wider">Risk Zones</h4>
                 <div class="space-y-2 text-xs">
                     <div class="flex items-center gap-2">
                         <div class="w-3 h-3 rounded-full bg-red-500"></div>
                         <span>High Risk Zone</span>
                     </div>
                     <div class="flex items-center gap-2">
                         <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                         <span>Medium Risk Zone</span>
                     </div>
                     <div class="flex items-center gap-2">
                         <div class="w-3 h-3 rounded-full bg-green-500"></div>
                         <span>Low/Safe Zone</span>
                     </div>
                 </div>
             </div>
        }
        else
        {
            <div class="h-full w-full flex items-center justify-center text-gray-500">
                <p>Select a location to view map.</p>
            </div>
        }
    </div>
</div>

@code {
    private bool IsCalculating = true;
    private string? _aiReportMarkdown;
    private MLDivisionPrediction? _mlPrediction;
    private (string ZoneName, double DistanceKm)? NearestSafeZone;
    private List<Shelter> NearbyShelters = new();
    private IJSObjectReference? _reportModule;

    protected override async Task OnInitializedAsync()
    {
        if (AppState.SelectedLatLng != null)
        {
            // Fetch nearby shelters
            NearbyShelters = await ShelterService.GetNearbySheltersAsync(AppState.SelectedLatLng, 15.0, 3);

            // 1. Fetch current weather first
            var weather = await WeatherService.GetCurrentWeatherAsync(
                AppState.SelectedLatLng.Lat, AppState.SelectedLatLng.Lng);
            
            double currentRainfall = weather?.Rain ?? 0;
            
            // 2. Determine Location Hierarchy for AI Context
            string province = "";
            string district = "";
            string division = AppState.SelectedLocationName ?? "Unknown";

            if (AppState.SelectedProvinceId.HasValue)
            {
                province = LocService.GetProvinces().FirstOrDefault(p => p.Id == AppState.SelectedProvinceId)?.Name ?? "";
            }
            if (AppState.SelectedDistrictId.HasValue)
            {
                district = LocService.GetDistricts(AppState.SelectedProvinceId ?? 0).FirstOrDefault(d => d.Id == AppState.SelectedDistrictId)?.Name ?? "";
            }
            
            // Get Historical Severity
            var histData = HistoricalData.GetHistoricalRisk(province, district, division);
            
            // Get ML Model Predictions
            _mlPrediction = MLPrediction.GetPredictionForDivision(division);

            // 3. Get Claude Prediction
            _aiReportMarkdown = await AIPredictor.PredictRiskAsync(
                province, district, division, currentRainfall, histData);

            // 4. Overwrite Legacy UI state based on Gemini assessment
            var result = await RiskService.CalculateRiskAsync(AppState.SelectedLatLng, currentRainfall);
            
            if (!string.IsNullOrEmpty(_aiReportMarkdown))
            {
                if (_aiReportMarkdown.Contains("HIGH")) result.Level = RiskLevel.High;
                else if (_aiReportMarkdown.Contains("MEDIUM")) result.Level = RiskLevel.Medium;
                else result.Level = RiskLevel.Low;
            }
            AppState.SetRiskResult(result);
            
            // 5. Find nearest safe zone for High/Medium risk
            if (result.Level != RiskLevel.Low)
            {
                NearestSafeZone = await RiskService.FindNearestSafeZoneAsync(AppState.SelectedLatLng);
            }
            
            IsCalculating = false;
        }
        else
        {
            IsCalculating = false;
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/location");
    }

    private void NewCheck()
    {
        Nav.NavigateTo("/location");
    }

    private async Task PrintReport()
    {
        _reportModule ??= await JS.InvokeAsync<IJSObjectReference>("import", "./js/report.js");
        await _reportModule.InvokeVoidAsync("printReport");
    }

    private void ReportDamage()
    {
        Nav.NavigateTo("/report-damage");
    }
}

<style>
    .risk-sidebar {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.05);
        scrollbar-width: thin;
        scrollbar-color: rgba(139, 92, 246, 0.3) transparent;
    }

    .risk-sidebar::-webkit-scrollbar {
        width: 4px;
    }

    .risk-sidebar::-webkit-scrollbar-track {
        background: transparent;
    }

    .risk-sidebar::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.3);
        border-radius: 2px;
    }

    .escalation-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 0.875rem;
        background: rgba(245, 158, 11, 0.12);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 0.5rem;
        animation: fadeSlideIn 0.5s ease-out;
    }

    .escalation-icon {
        font-size: 1rem;
        flex-shrink: 0;
    }

    .escalation-text {
        font-size: 0.75rem;
        color: #fbbf24;
        font-weight: 500;
    }

    .safe-zone-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: rgba(16, 185, 129, 0.08);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: 0.5rem;
    }

    .safe-zone-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #d1d5db;
        font-weight: 500;
    }

    .safe-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #10b981;
        animation: safePulse 2s infinite;
    }

    @@keyframes safePulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5); }
        50% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
    }

    .safe-zone-distance {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .distance-value {
        font-size: 1.125rem;
        font-weight: 700;
        color: #10b981;
    }

    .distance-label {
        font-size: 0.625rem;
        color: #6b7280;
        text-transform: uppercase;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    @@keyframes fadeSlideIn {
        from { opacity: 0; transform: translateY(-8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Print styles */
    @@media print {
        .risk-panel {
            overflow: visible !important;
            height: auto !important;
        }
        .action-buttons,
        .app-btn-ghost {
            display: none !important;
        }
        body {
            background: white !important;
            color: black !important;
        }
        .app-panel {
            border: 1px solid #ccc !important;
            break-inside: avoid;
        }
    }
</style>
