@page "/risk"
@using FloodApp.State
@using FloodApp.Services
@using FloodApp.Models
@using FloodApp.Components.UI
@using FloodApp.Components.Maps
@inject NavigationManager Nav
@inject AppState AppState
@inject RiskService RiskService
@inject WeatherService WeatherService
@inject ShelterService ShelterService
@inject HistoricalDataService HistoricalData
@inject MLPredictionService MLPrediction
@inject AIFloodPredictor AIPredictor
@inject LocationService LocService
@inject IJSRuntime JS
@layout FloodApp.Components.Layout.MainLayout

<div class="h-screen w-full flex flex-col overflow-hidden bg-gray-900 text-white">
    <!-- ZONE 1: Map (60vh desktop, 45vh mobile) -->
    <div class="w-full h-[45vh] md:h-[60vh] bg-black shrink-0 relative">
        
        <!-- The Map Layer -->
        <!-- Important: the map needs absolute positioning behind our HUD -->
        <div class="absolute inset-0 z-[10]">
            @if (AppState.SelectedLatLng != null)
            {
                 <RiskMapView Shelters="@NearbyShelters" />
            }
            else
            {
                <div class="h-full w-full flex items-center justify-center text-gray-500">
                    <p>Select a location to view map.</p>
                </div>
            }
        </div>

        <!-- Overlays Layer (HUD) -->
        <div class="absolute inset-0 pointer-events-none p-4 z-[1000] flex flex-col justify-between">
            
            <!-- Top section of overlays -->
            <div class="flex justify-between items-start">
                
                <!-- Top Left: Back btn + Risk + Stats -->
                <div class="flex flex-col gap-3 pointer-events-auto max-w-[250px] sm:max-w-none">
                    <!-- Back button -->
                    <button @onclick="GoBack" class="flex items-center gap-1 text-sm bg-slate-800/90 hover:bg-slate-700 backdrop-blur-md px-3 py-1.5 rounded-lg border border-white/20 shadow-xl text-white transition-colors w-max cursor-pointer">
                        <Icon SvgContent='<path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' />
                        Back
                    </button>

                    @if (AppState.SelectedLatLng != null && !IsCalculating)
                    {
                        <!-- Risk Level Card -->
                        <div class="glass-popup border-[2px] @(AppState.CurrentRisk.Level == RiskLevel.High ? "border-red-500/80 shadow-[0_0_15px_rgba(239,68,68,0.5)]" : AppState.CurrentRisk.Level == RiskLevel.Medium ? "border-yellow-500/80 shadow-[0_0_15px_rgba(245,158,11,0.5)]" : "border-green-500/80 shadow-[0_0_15px_rgba(16,185,129,0.5)]")">
                            <h2 class="text-[0.65rem] uppercase tracking-wider text-gray-300 font-bold mb-1">Current Risk Level</h2>
                            <div class="flex items-center gap-3">
                                <div class="text-2xl sm:text-3xl font-black @(AppState.CurrentRisk.Level == RiskLevel.High ? "text-red-500" : AppState.CurrentRisk.Level == RiskLevel.Medium ? "text-yellow-500" : "text-green-500")">
                                    @(AppState.CurrentRisk.Level.ToString().ToUpper())
                                </div>
                                <div class="text-xs sm:text-sm font-medium text-gray-200 border-l border-white/20 pl-3">
                                    @LocService.GetProvinces().FirstOrDefault(p => p.Id == AppState.SelectedProvinceId)?.Name <br/>
                                    <span class="text-white font-bold block truncate max-w-[120px] sm:max-w-[200px]">@AppState.SelectedLocationName</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats Card -->
                        <div class="glass-popup flex gap-3 sm:gap-4 divide-x divide-white/20 border border-white/10">
                            <div>
                                <div class="text-[0.55rem] sm:text-[0.65rem] uppercase text-gray-400 font-bold">Rain</div>
                                <div class="font-bold text-secondary text-xs sm:text-sm mt-0.5">@(_currentRainfall.ToString("F1")) mm</div>
                            </div>
                            <div class="pl-3 sm:pl-4">
                                <div class="text-[0.55rem] sm:text-[0.65rem] uppercase text-gray-400 font-bold">Affected</div>
                                <div class="font-bold text-primary text-xs sm:text-sm mt-0.5">@(_mlPrediction?.PredictedAffected ?? 0)</div>
                            </div>
                            <div class="pl-3 sm:pl-4">
                                <div class="text-[0.55rem] sm:text-[0.65rem] uppercase text-gray-400 font-bold">Safe Zone</div>
                                <div class="font-bold text-green-400 text-xs sm:text-sm mt-0.5">@(NearestSafeZone?.DistanceKm.ToString("F1") ?? "--") km</div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Top Right: Emergency Hotlines -->
                <div class="glass-popup pointer-events-auto flex flex-col gap-2 border border-white/10">
                    <a href="tel:117" class="flex items-center gap-3 hover:bg-white/10 p-1.5 rounded transition">
                        <div class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center text-red-500 border border-red-500/50">üö®</div>
                        <div>
                            <div class="text-[0.65rem] text-gray-400 uppercase leading-none font-bold">DMC</div>
                            <div class="font-bold text-white text-sm mt-0.5">117</div>
                        </div>
                    </a>
                    <a href="tel:119" class="flex items-center gap-3 hover:bg-white/10 p-1.5 rounded transition">
                        <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500 border border-blue-500/50">üöì</div>
                        <div>
                            <div class="text-[0.65rem] text-gray-400 uppercase leading-none font-bold">Police</div>
                            <div class="font-bold text-white text-sm mt-0.5">119</div>
                        </div>
                    </a>
                    <a href="tel:1990" class="flex items-center gap-3 hover:bg-white/10 p-1.5 rounded transition">
                        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-500 border border-green-500/50">üöë</div>
                        <div>
                            <div class="text-[0.65rem] text-gray-400 uppercase leading-none font-bold">Ambulance</div>
                            <div class="font-bold text-white text-sm mt-0.5">1990</div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Bottom section of overlays -->
            <div class="flex justify-end pointer-events-auto">
                <!-- Risk Legend Overlay -->
                <div class="glass-popup border border-white/10 hidden sm:block">
                    <h4 class="text-[0.65rem] font-bold text-secondary mb-2 uppercase tracking-wider">Risk Zones</h4>
                    <div class="space-y-1.5 text-xs text-gray-200 font-medium">
                        <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_5px_rgba(239,68,68,0.8)]"></div>
                            <span>High Risk</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500 shadow-[0_0_5px_rgba(245,158,11,0.8)]"></div>
                            <span>Medium Risk</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(16,185,129,0.8)]"></div>
                            <span>Low/Safe</span>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>

    <!-- ZONE 2: Tabbed Detail Panel (40vh desktop, 55vh mobile) -->
    <div class="flex-1 flex flex-col bg-slate-900 w-full border-t border-white/10 relative z-20 min-h-0">
        
        <!-- Tab Bar -->
        <div class="bg-[#1e293b] flex overflow-x-auto hide-scrollbar border-b border-white/5 z-30 shrink-0">
            <button @onclick="@(() => SetActiveTab("AI"))" class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 px-4 sm:px-6 py-3 sm:py-4 border-b-2 font-medium transition-colors whitespace-nowrap flex-1 sm:flex-auto @(_activeTab == "AI" ? "border-[#7c3aed] text-white bg-white/5" : "border-transparent text-gray-400 hover:text-gray-200 hover:bg-white/5")">
                <span class="text-xl sm:text-base">ü§ñ</span><span class="text-[0.65rem] sm:text-sm uppercase sm:capitalize tracking-wider sm:tracking-normal">AI Stats</span>
            </button>
            <button @onclick="@(() => SetActiveTab("Weather"))" class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 px-4 sm:px-6 py-3 sm:py-4 border-b-2 font-medium transition-colors whitespace-nowrap flex-1 sm:flex-auto @(_activeTab == "Weather" ? "border-[#7c3aed] text-white bg-white/5" : "border-transparent text-gray-400 hover:text-gray-200 hover:bg-white/5")">
                <span class="text-xl sm:text-base">üåßÔ∏è</span><span class="text-[0.65rem] sm:text-sm uppercase sm:capitalize tracking-wider sm:tracking-normal">Weather</span>
            </button>
            <button @onclick="@(() => SetActiveTab("Shelters"))" class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 px-4 sm:px-6 py-3 sm:py-4 border-b-2 font-medium transition-colors whitespace-nowrap flex-1 sm:flex-auto @(_activeTab == "Shelters" ? "border-[#7c3aed] text-white bg-white/5" : "border-transparent text-gray-400 hover:text-gray-200 hover:bg-white/5")">
                <span class="text-xl sm:text-base">üè•</span><span class="text-[0.65rem] sm:text-sm uppercase sm:capitalize tracking-wider sm:tracking-normal">Shelters</span>
            </button>
            <button @onclick="@(() => SetActiveTab("Recs"))" class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 px-4 sm:px-6 py-3 sm:py-4 border-b-2 font-medium transition-colors whitespace-nowrap flex-1 sm:flex-auto @(_activeTab == "Recs" ? "border-[#7c3aed] text-white bg-white/5" : "border-transparent text-gray-400 hover:text-gray-200 hover:bg-white/5")">
                <span class="text-xl sm:text-base">üìã</span><span class="text-[0.65rem] sm:text-sm uppercase sm:capitalize tracking-wider sm:tracking-normal">Action</span>
            </button>
            <button @onclick="@(() => SetActiveTab("Report"))" class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 px-4 sm:px-6 py-3 sm:py-4 border-b-2 font-medium transition-colors whitespace-nowrap flex-1 sm:flex-auto @(_activeTab == "Report" ? "border-[#7c3aed] text-white bg-white/5" : "border-transparent text-gray-400 hover:text-gray-200 hover:bg-white/5")">
                <span class="text-xl sm:text-base">üìù</span><span class="text-[0.65rem] sm:text-sm uppercase sm:capitalize tracking-wider sm:tracking-normal">Report</span>
            </button>
        </div>

        <!-- Tab Content Area -->
        <div class="flex-1 overflow-y-auto p-4 md:p-6 pb-20 sm:pb-12 bg-gray-900/50">
            @if (IsCalculating)
            {
                <div class="flex-1 flex flex-col items-center justify-center gap-4 h-full min-h-[200px]">
                    <div class="spinner border-4 border-purple-500 border-t-transparent rounded-full w-12 h-12 animate-spin"></div>
                    <p>Analyzing Risk Data...</p>
                </div>
            }
            else if (AppState.SelectedLatLng == null)
            {
                 <div class="flex-1 flex items-center justify-center h-full min-h-[200px]">
                    <AppButton OnClick="GoBack">Select Location</AppButton>
                </div>
            }
            else
            {
                <!-- Tab 1: AI Assessment -->
                <div class="@(_activeTab == "AI" ? "block" : "hidden") space-y-4 max-w-4xl mx-auto h-full animate-fade-in">
                    <div class="bg-slate-800/80 backdrop-blur border border-white/5 rounded-xl p-5 shadow-lg">
                        <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-700">
                            <span class="text-xl">‚ú®</span>
                            <h3 class="text-md font-bold text-white">Claude GenAI Assessment</h3>
                        </div>
                        @if (!string.IsNullOrEmpty(_aiReportMarkdown))
                        {
                            <pre class="text-sm text-gray-300 whitespace-pre-wrap font-sans leading-relaxed">@_aiReportMarkdown</pre>
                        }
                        else
                        {
                            <p class="text-sm text-yellow-400">Failed to generate AI Risk Report.</p>
                        }
                    </div>

                    @if (_mlPrediction != null)
                    {
                        <div class="bg-gradient-to-r from-purple-900/40 to-slate-800 border border-purple-500/30 rounded-xl p-5 shadow-lg">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="text-xl">ü§ñ</span>
                                <h3 class="text-md font-bold text-white">Predictive ML Model (Random Forest)</h3>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-black/40 p-4 rounded-lg border border-white/5">
                                    <h4 class="text-xs text-gray-400 uppercase tracking-widest font-semibold mb-2">Division Profile (Historical)</h4>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-300">Based on @(_mlPrediction.HistoricalEventCount) past events</span>
                                        <div class="px-3 py-1 text-xs rounded font-bold border 
                                            @(_mlPrediction.PredictedSeverity == "HIGH" ? "text-red-500 border-red-900 bg-red-900/20" :
                                              _mlPrediction.PredictedSeverity == "MEDIUM" ? "text-yellow-500 border-yellow-900 bg-yellow-900/20" : 
                                              "text-green-500 border-green-900 bg-green-900/20")">
                                            @_mlPrediction.PredictedSeverity
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-black/40 p-4 rounded-lg border border-white/5">
                                    <h4 class="text-xs text-gray-400 uppercase tracking-widest font-semibold mb-2">Impact Forecast</h4>
                                    <div class="flex flex-col">
                                        <span class="text-sm text-gray-300">Predicted affected population today</span>
                                        <div class="font-black text-2xl text-primary mt-1">
                                            @(_mlPrediction.PredictedAffected) <span class="text-sm font-normal text-gray-400">people</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Tab 2: Weather -->
                <div class="@(_activeTab == "Weather" ? "block" : "hidden") max-w-4xl mx-auto space-y-6 animate-fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Panel>
                            <WeatherWidget Location="@AppState.SelectedLatLng" />
                        </Panel>
                        <Panel>
                            <ForecastWidget Location="@AppState.SelectedLatLng" />
                        </Panel>
                    </div>
                    <Panel>
                        <RainfallChart Location="@AppState.SelectedLatLng" />
                    </Panel>
                </div>

                <!-- Tab 3: Shelters -->
                <div class="@(_activeTab == "Shelters" ? "block" : "hidden") max-w-4xl mx-auto animate-fade-in">
                    @if (NearbyShelters != null && NearbyShelters.Any())
                    {
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            @foreach (var shelter in NearbyShelters)
                            {
                                <div class="p-4 bg-slate-800/80 hover:bg-slate-700 transition rounded-xl border border-white/10 flex flex-col justify-between shadow-lg">
                                    <div>
                                        <div class="flex justify-between items-start mb-2">
                                            <span class="font-bold text-gray-100 text-base sm:text-lg pr-2">@shelter.Name</span>
                                            <span class="text-xs bg-secondary/20 text-secondary border border-secondary/30 px-2 py-1 rounded-full font-semibold whitespace-nowrap">@shelter.DistanceKm.ToString("F1") km</span>
                                        </div>
                                        <div class="text-sm text-gray-400 flex items-center gap-2 mb-4">
                                            <span>@(shelter.Type.ToString() == "School" ? "üè´" : shelter.Type.ToString() == "Temple" ? "üõï" : "üè¢")</span>
                                            <span>@shelter.Type.ToString()</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between border-t border-white/10 pt-3">
                                        <a href="tel:@shelter.ContactNumber" class="text-sm font-medium hover:underline flex items-center gap-2 text-white bg-white/5 px-2 sm:px-3 py-1.5 rounded-lg transition hover:bg-white/10">
                                            üìû @shelter.ContactNumber
                                        </a>
                                        <div class="text-xs sm:text-sm font-bold px-2 sm:px-3 py-1.5 rounded-lg @(shelter.IsFull ? "bg-red-500/20 text-red-400 border border-red-500/30" : "bg-green-500/20 text-green-400 border border-green-500/30")">
                                            @(shelter.IsFull ? "FULL" : $"Cap: {shelter.CurrentOccupancy}/{shelter.Capacity}")
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center p-8 text-gray-400 bg-slate-800/50 rounded-xl border border-white/5">
                            No emergency centers found within a 15km radius.
                        </div>
                    }
                </div>

                <!-- Tab 4: Recommendations -->
                <div class="@(_activeTab == "Recs" ? "block" : "hidden") max-w-3xl mx-auto animate-fade-in shadow-lg">
                    <div class="bg-slate-800/80 backdrop-blur border border-white/5 rounded-xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <span class="text-2xl">üìã</span>
                            <h3 class="text-lg font-bold text-white">Actionable Recommendations</h3>
                        </div>
                        
                        <ul class="space-y-4">
                            @if (AppState.CurrentRisk.Level == RiskLevel.High)
                            {
                                <li class="flex items-start gap-3 bg-red-500/10 p-4 rounded-lg border border-red-500/20">
                                    <span class="text-red-500 mt-0.5">‚ö†Ô∏è</span>
                                    <div>
                                        <span class="block font-bold text-red-400 mb-1">Evacuate Immediately</span>
                                        <span class="text-sm text-gray-300">Move to higher ground or the nearest safe zone. Do not wait for water to rise.</span>
                                    </div>
                                </li>
                                <li class="flex items-start gap-3 bg-white/5 p-4 rounded-lg border border-white/5">
                                    <span class="text-primary mt-0.5">üéí</span>
                                    <div>
                                        <span class="block font-bold text-white mb-1">Take Emergency Kit</span>
                                        <span class="text-sm text-gray-300">Ensure you have water, non-perishable food, flashlight, medications, and IDs.</span>
                                    </div>
                                </li>
                                <li class="flex items-start gap-3 bg-white/5 p-4 rounded-lg border border-white/5">
                                    <span class="text-secondary mt-0.5">üìª</span>
                                    <div>
                                        <span class="block font-bold text-white mb-1">Follow DMC Alerts</span>
                                        <span class="text-sm text-gray-300">Monitor local radio and official SMS channels closely.</span>
                                    </div>
                                </li>
                                <li class="flex items-start gap-3 bg-white/5 p-4 rounded-lg border border-white/5">
                                    <span class="text-yellow-500 mt-0.5">üõë</span>
                                    <div>
                                        <span class="block font-bold text-white mb-1">Avoid Flooded Roads</span>
                                        <span class="text-sm text-gray-300">Do not attempt to cross flooded roads or bridges, either on foot or in vehicles.</span>
                                    </div>
                                </li>
                            }
                            else if (AppState.CurrentRisk.Level == RiskLevel.Medium)
                            {
                                <li class="flex items-start gap-3 bg-yellow-500/10 p-4 rounded-lg border border-yellow-500/20">
                                    <span class="text-yellow-500 mt-0.5">üëÄ</span>
                                    <div>
                                        <span class="block font-bold text-yellow-400 mb-1">Monitor Rain Levels</span>
                                        <span class="text-sm text-gray-300">Pay close attention to continuous rainfall and local water bodies.</span>
                                    </div>
                                </li>
                                <li class="flex items-start gap-3 bg-white/5 p-4 rounded-lg border border-white/5">
                                    <span class="text-primary mt-0.5">üéí</span>
                                    <div>
                                        <span class="block font-bold text-white mb-1">Prepare to Evacuate</span>
                                        <span class="text-sm text-gray-300">Have an emergency bag packed and ready to go just in case.</span>
                                    </div>
                                </li>
                                <li class="flex items-start gap-3 bg-white/5 p-4 rounded-lg border border-white/5">
                                    <span class="text-secondary mt-0.5">üìÅ</span>
                                    <div>
                                        <span class="block font-bold text-white mb-1">Secure Valuables</span>
                                        <span class="text-sm text-gray-300">Move important documents, electronics, and valuables to higher shelves or upper floors.</span>
                                    </div>
                                </li>
                            }
                            else
                            {
                                <li class="flex items-start gap-3 bg-green-500/10 p-4 rounded-lg border border-green-500/20">
                                    <span class="text-green-500 mt-0.5">‚úÖ</span>
                                    <div>
                                        <span class="block font-bold text-green-400 mb-1">Area is Safe</span>
                                        <span class="text-sm text-gray-300">Currently, there is no immediate flood threat based on data models.</span>
                                    </div>
                                </li>
                                <li class="flex items-start gap-3 bg-white/5 p-4 rounded-lg border border-white/5">
                                    <span class="text-primary mt-0.5">üåßÔ∏è</span>
                                    <div>
                                        <span class="block font-bold text-white mb-1">Stay Updated</span>
                                        <span class="text-sm text-gray-300">Keep checking the app during the monsoon season for changes.</span>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>

                <!-- Tab 5: Report Damage -->
                <div class="@(_activeTab == "Report" ? "block" : "hidden") max-w-2xl mx-auto text-center py-8 px-4 animate-fade-in">
                    <div class="mb-8">
                        <div class="text-5xl mb-4">üè†üí¶</div>
                        <h3 class="text-2xl font-bold text-white mb-2">Affected by Flooding?</h3>
                        <p class="text-gray-400 max-w-md mx-auto">Submit a direct report to the Disaster Management Center and initiate your insurance claim process with SLIC instantly.</p>
                    </div>
                    
                    <div class="flex flex-col gap-4 max-w-sm mx-auto">
                        <AppButton Class="w-full text-lg shadow-[0_0_20px_rgba(239,68,68,0.3)] hover:shadow-[0_0_30px_rgba(239,68,68,0.5)] transition-all" 
                                   Variant="AppButton.ButtonVariant.Filled"
                                   Color="AppButton.ButtonColor.Danger"
                                   OnClick="@ReportDamageAction">
                            üö® Report Damage Now
                        </AppButton>
                        
                        <div class="flex sm:flex-row flex-col gap-4 mt-4">
                            <AppButton Class="flex-1" 
                                       Variant="AppButton.ButtonVariant.Outline"
                                       Color="AppButton.ButtonColor.Primary"
                                       OnClick="@PrintReport">
                                üìÑ Download
                            </AppButton>
                            <AppButton Class="flex-1" 
                                       Variant="AppButton.ButtonVariant.Outline"
                                       Color="AppButton.ButtonColor.Neutral"
                                       OnClick="@NewCheck">
                                üìç Change Loc
                            </AppButton>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool IsCalculating = true;
    private string? _aiReportMarkdown;
    private MLDivisionPrediction? _mlPrediction;
    private (string ZoneName, double DistanceKm)? NearestSafeZone;
    private List<Shelter> NearbyShelters = new();
    private IJSObjectReference? _reportModule;
    private double _currentRainfall = 0;
    
    private string _activeTab = "AI";

    private void SetActiveTab(string tab)
    {
        _activeTab = tab;
    }

    protected override async Task OnInitializedAsync()
    {
        if (AppState.SelectedLatLng != null)
        {
            NearbyShelters = await ShelterService.GetNearbySheltersAsync(AppState.SelectedLatLng, 15.0, 3);

            var weather = await WeatherService.GetCurrentWeatherAsync(
                AppState.SelectedLatLng.Lat, AppState.SelectedLatLng.Lng);
            
            _currentRainfall = weather?.Rain ?? 0;
            
            string province = "";
            string district = "";
            string division = AppState.SelectedLocationName ?? "Unknown";

            if (AppState.SelectedProvinceId.HasValue)
            {
                province = LocService.GetProvinces().FirstOrDefault(p => p.Id == AppState.SelectedProvinceId)?.Name ?? "";
            }
            if (AppState.SelectedDistrictId.HasValue)
            {
                district = LocService.GetDistricts(AppState.SelectedProvinceId ?? 0).FirstOrDefault(d => d.Id == AppState.SelectedDistrictId)?.Name ?? "";
            }
            
            var histData = HistoricalData.GetHistoricalRisk(province, district, division);
            _mlPrediction = MLPrediction.GetPredictionForDivision(division);
            string mlSeverity = _mlPrediction?.PredictedSeverity ?? "LOW";
            
            _aiReportMarkdown = await AIPredictor.PredictRiskAsync(
                province, district, division, _currentRainfall, histData, mlSeverity);

            var result = await RiskService.CalculateRiskAsync(AppState.SelectedLatLng, _currentRainfall);
            
            // Sync overall UI Risk Level strictly with ML Prediction
            if (mlSeverity == "HIGH") result.Level = RiskLevel.High;
            else if (mlSeverity == "MEDIUM") result.Level = RiskLevel.Medium;
            else result.Level = RiskLevel.Low;
            AppState.SetRiskResult(result);
            
            if (result.Level != RiskLevel.Low)
            {
                NearestSafeZone = await RiskService.FindNearestSafeZoneAsync(AppState.SelectedLatLng);
            }
            
            IsCalculating = false;
        }
        else
        {
            IsCalculating = false;
        }
    }

    private void GoBack() => Nav.NavigateTo("/location");
    private void NewCheck() => Nav.NavigateTo("/location");

    private async Task PrintReport()
    {
        _reportModule ??= await JS.InvokeAsync<IJSObjectReference>("import", "./js/report.js");
        await _reportModule.InvokeVoidAsync("printReport");
    }

    private void ReportDamageAction() => Nav.NavigateTo("/report-damage");
}

<style>
    .glass-popup {
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(4px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Print styles */
    @@media print {
        .risk-panel {
            overflow: visible !important;
            height: auto !important;
        }
        .action-buttons,
        .app-btn-ghost,
        nav, header {
            display: none !important;
        }
        body {
            background: white !important;
            color: black !important;
        }
    }
</style>
