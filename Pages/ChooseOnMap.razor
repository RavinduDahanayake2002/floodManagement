@page "/choose-on-map"
@using FloodApp.Components.Maps
@using FloodApp.Components.UI
@using FloodApp.State
@using FloodApp.Models
@inject AppState AppState
@inject NavigationManager Nav
@layout FloodApp.Components.Layout.MainLayout

<div class="h-screen w-full relative">
    <MapPicker OnLocationPicked="OnLocationPicked" />

    <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-900/90 p-4 rounded-xl border border-gray-700 shadow-xl flex gap-4 z-[1000]">
        <div class="flex flex-col">
            <span class="text-xs text-secondary">Selected Location</span>
            <span class="font-mono text-sm">
                @if (SelectedLoc != null)
                {
                    @($"{SelectedLoc.Lat:F4}, {SelectedLoc.Lng:F4}")
                }
                else
                {
                    @("Click map to select")
                }
            </span>
        </div>

        <AppButton Color="AppButton.ButtonColor.Primary" 
                   Disabled="@(SelectedLoc == null)"
                   OnClick="ConfirmSelection">
            Confirm Location
        </AppButton>
        
         <AppButton Variant="AppButton.ButtonVariant.Ghost" 
                   Color="AppButton.ButtonColor.Neutral"
                   OnClick="@(() => Nav.NavigateTo("/location"))">
            Cancel
        </AppButton>
    </div>
</div>

@code {
    private LatLng? SelectedLoc;

    protected override void OnInitialized()
    {
        SelectedLoc = AppState.SelectedLatLng;
    }

    private void OnLocationPicked(LatLng latLng)
    {
        SelectedLoc = latLng;
    }

    private void ConfirmSelection()
    {
        if (SelectedLoc != null)
        {
            AppState.SetExplicitLocation(SelectedLoc);
            Nav.NavigateTo("/risk");
        }
    }
}
